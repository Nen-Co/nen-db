name: WASM Build

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup dependencies
      run: |
        echo "🔗 Setting up dependencies"
        cd ..
        git clone https://github.com/Nen-Co/nen-core.git
        git clone https://github.com/Nen-Co/nen-io.git
        git clone https://github.com/Nen-Co/nen-json.git
        git clone https://github.com/Nen-Co/nen-net.git
        cd nen-db
    
    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.1
        
    - name: Build WASM
      run: zig build wasm
      
    - name: Check WASM output
      run: |
        ls -la zig-out/bin/
        file zig-out/bin/nendb-wasm.wasm
        du -h zig-out/bin/nendb-wasm.wasm
        
    - name: Upload WASM artifact
      uses: actions/upload-artifact@v4
      with:
        name: nendb-wasm
        path: |
          zig-out/bin/nendb-wasm.wasm
          wasm/nendb-wasm.js
          wasm/example.html
        retention-days: 30
        
    - name: Create Release (on tags)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          zig-out/bin/nendb-wasm.wasm
          wasm/nendb-wasm.js
          wasm/example.html
        body: |
          ## NenDB WASM Release
          
          **Embedded Graph Database for Browser/WASM environments**
          
          ### 📦 Downloads:
          - `nendb-wasm.wasm` - The core WASM module (~37KB)
          - `nendb-wasm.js` - JavaScript wrapper for easy integration
          - `example.html` - Complete working example
          
          ### ✨ Features:
          - **Static memory allocation** - predictable performance in WASM
          - **Zero dependencies** - pure Zig compiled to minimal WASM
          - **Graph database operations** - nodes, edges, properties
          - **JavaScript interop** - C-style exports for easy integration
          
          ### 🚀 Quick Start:
          ```javascript
          import NenDB from './nendb-wasm.js';
          const db = await NenDB.loadFromURL('./nendb-wasm.wasm');
          const nodeId = db.addNode(123);
          console.log('Nodes:', db.getNodeCount());
          ```
          
          Perfect for browser-based graph applications, data visualization, and embedded use cases where you need SQLite-like simplicity but for graph data.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-wasm:
    runs-on: ubuntu-latest
    needs: build-wasm
    steps:
    - uses: actions/checkout@v4
    
    - name: Download WASM artifact  
      uses: actions/download-artifact@v4
      with:
        name: nendb-wasm
        path: ./built-wasm/
        
    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Test WASM loading
      run: |
        cd built-wasm
        echo "Checking downloaded artifact structure..."
        find . -name "*.wasm" -type f
        ls -la
        
        echo "Testing WASM file integrity..."
        WASM_FILE=$(find . -name "nendb-wasm.wasm" -type f | head -1)
        if [ -z "$WASM_FILE" ]; then
          echo "❌ WASM file not found!"
          exit 1
        fi
        
        file "$WASM_FILE" || true
        
        # Simple Node.js test to verify WASM can be loaded using WASI imports
        cat > test.js << 'EOF'
        const fs = require('fs');
        const { WASI } = require('wasi');
        const path = require('path');

        async function test(wasmPath) {
          try {
            if (!wasmPath) throw new Error('WASM path argument missing');
            const absPath = path.resolve(wasmPath);
            if (!fs.existsSync(absPath)) throw new Error(`WASM file not found: ${absPath}`);

            const wasmBytes = fs.readFileSync(absPath);
            console.log('✅ WASM file loaded, size:', wasmBytes.length, 'bytes');

            const wasi = new WASI({ args: [], env: process.env, preopens: { ["/": process.cwd()] } });
            const importObject = { wasi_snapshot_preview1: wasi.wasiImport };

            const { instance } = await WebAssembly.instantiate(wasmBytes, importObject);
            console.log('✅ WASM module instantiated successfully');
            console.log('Exports:', Object.keys(instance.exports).slice(0, 10), '...');

            if (typeof instance.exports._start === 'function') {
              try {
                // _start is the WASI entrypoint; run it under the WASI instance
                wasi.start(instance);
                console.log('✅ WASM _start executed (if present)');
              } catch (e) {
                console.warn('⚠️ WASM _start threw:', e);
              }
            } else {
              console.log('ℹ️ No _start export; WASM module loaded for inspection only');
            }
          } catch (error) {
            console.error('❌ WASM test failed:', error);
            process.exitCode = 1;
          }
        }

        const wasmArg = process.argv[2];
        test(wasmArg).then(() => {}).catch(() => process.exit(1));
        EOF

        # Pass the located wasm file into Node
        node test.js "$WASM_FILE"