name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  ZIG_VERSION: "0.15.1"

jobs:
  # Single comprehensive job that does everything
  test-and-build:
    name: Test and Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        build-mode: [ReleaseFast]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup dependencies
      run: |
        echo "ğŸ”— Setting up dependencies"
        cd ..
        git clone https://github.com/Nen-Co/nen-core.git
        git clone https://github.com/Nen-Co/nen-io.git
        git clone https://github.com/Nen-Co/nen-json.git
        git clone https://github.com/Nen-Co/nen-net.git
        cd nen-db

    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        zig-version: ${{ env.ZIG_VERSION }}

    - name: Cache Zig build
      uses: actions/cache@v3
      with:
        path: .zig-cache
        key: zig-${{ matrix.os }}-${{ matrix.build-mode }}-${{ hashFiles('**/*.zig') }}

    - name: Build and Test
      run: |
        echo "ğŸ” Building ${{ matrix.build-mode }} on ${{ matrix.os }}"
        zig build -Doptimize=${{ matrix.build-mode == 'Debug' && 'Debug' || 'ReleaseFast' }}
        zig build test
        zig build nendb
        ls -l zig-out/bin/

    - name: Test WASM build
      if: matrix.os == 'ubuntu-latest'
      run: |
        echo "ğŸŒ Testing WASM build (networking disabled)"
        zig build nendb-wasm
        echo "âœ… WASM build completed (HTTP server not available in WASM)"

    - name: Test HTTP server
      if: matrix.os == 'ubuntu-latest' && matrix.build-mode == 'ReleaseFast'
      run: |
        echo "ğŸš€ Testing HTTP server functionality"
        timeout 5s ./zig-out/bin/nendb serve || true
        echo "âœ… HTTP server test completed"