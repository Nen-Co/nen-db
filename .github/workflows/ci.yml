name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  ZIG_VERSION: "0.15.1"

jobs:
  # Single comprehensive job that does everything
  test-and-build:
    name: Test and Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        build-mode: [ReleaseFast]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup dependencies
      shell: bash
      run: |
        echo "üîó Setting up dependencies"
        mkdir -p ../
        cd ../
        
        # Clone dependencies if they don't exist
        if [ ! -d "nen-core" ]; then
          git clone https://github.com/Nen-Co/nen-core.git
        fi
        if [ ! -d "nen-io" ]; then
          git clone https://github.com/Nen-Co/nen-io.git
        fi
        if [ ! -d "nen-json" ]; then
          git clone https://github.com/Nen-Co/nen-json.git
        fi
        if [ ! -d "nen-net" ]; then
          git clone https://github.com/Nen-Co/nen-net.git
        fi

    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        zig-version: ${{ env.ZIG_VERSION }}

    - name: Cache Zig build
      uses: actions/cache@v3
      with:
        path: .zig-cache
        key: zig-${{ matrix.os }}-${{ matrix.build-mode }}-${{ hashFiles('**/*.zig') }}

    - name: Build and Test
      run: |
        echo "üîç Building ${{ matrix.build-mode }} on ${{ matrix.os }}"
        
        # Build the project
        zig build --release=${{ matrix.build-mode == 'Debug' && 'safe' || 'fast' }}
        
        # Run tests
        zig build test
        
        # Test specific executables
        zig build nendb
        zig build nendb-http-server
        zig build nendb-tcp-server

    - name: Test WASM build
      if: matrix.os == 'ubuntu-latest'
      run: |
        echo "üåê Testing WASM build"
        zig build nendb-wasm

    - name: Run integration demo
      if: matrix.os == 'ubuntu-latest' && matrix.build-mode == 'ReleaseFast'
      run: |
        echo "üöÄ Running integration demo"
        zig build demo-nen-core

  # Windows-specific build (separate due to different shell requirements)
  test-windows:
    name: Test Windows
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup dependencies
      shell: cmd
      run: |
        echo Setting up dependencies
        mkdir ..\deps
        cd ..\deps
        
        git clone https://github.com/Nen-Co/nen-core.git
        git clone https://github.com/Nen-Co/nen-io.git
        git clone https://github.com/Nen-Co/nen-json.git
        git clone https://github.com/Nen-Co/nen-net.git
        
        cd ..\nendb

    - name: Install Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        zig-version: ${{ env.ZIG_VERSION }}

    - name: Build and Test
      shell: cmd
      run: |
        echo Building ReleaseFast on Windows
        zig build --release=fast
        zig build test
        zig build nendb
        zig build nendb-http-server
        zig build nendb-tcp-server