<!DOCTYPE html>
<html>
<head>
    <title>NenDB WASM Example</title>
    <style>
        body { font-family: monospace; margin: 40px; background: #1a1a1a; color: #fff; }
        .output { background: #2a2a2a; padding: 20px; border-radius: 8px; margin: 20px 0; }
        button { background: #4a4a4a; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #5a5a5a; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 20px 0; }
        .stat { background: #3a3a3a; padding: 15px; border-radius: 4px; text-align: center; }
        .stat-value { font-size: 1.5em; color: #4fa8da; }
    </style>
</head>
<body>
    <h1>üöÄ NenDB WASM - Embedded Graph Database</h1>
    
    <div class="output">
        <h3>Status:</h3>
        <div id="status">Loading WASM module...</div>
    </div>

    <div class="stats">
        <div class="stat">
            <div class="stat-value" id="nodeCount">0</div>
            <div>Nodes</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="edgeCount">0</div>
            <div>Edges</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="opsCount">0</div>
            <div>Operations</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="memoryUsage">0</div>
            <div>Memory (bytes)</div>
        </div>
    </div>

    <div>
        <button onclick="addRandomNode()">Add Random Node</button>
        <button onclick="addRandomEdge()">Add Random Edge</button>
        <button onclick="addBatch()">Add 100 Nodes</button>
        <button onclick="benchmark()">Benchmark</button>
        <button onclick="updateStats()">Refresh Stats</button>
    </div>

    <div class="output">
        <h3>Log:</h3>
        <div id="log"></div>
    </div>

    <script type="module">
        let db = null;
        let nodeIdCounter = 1;

        function log(message) {
            const logEl = document.getElementById('log');
            logEl.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateStats() {
            if (!db) return;
            
            document.getElementById('nodeCount').textContent = db.getNodeCount();
            document.getElementById('edgeCount').textContent = db.getEdgeCount();
            document.getElementById('opsCount').textContent = db.getOpsCount().toString();
            document.getElementById('memoryUsage').textContent = db.getMemoryUsage().toString();
        }

        window.addRandomNode = function() {
            if (!db) return;
            const nodeId = nodeIdCounter++;
            const result = db.addNode(nodeId);
            if (result !== null) {
                log(`Added node ${nodeId} (index: ${result})`);
            } else {
                log(`Failed to add node ${nodeId} - pool full?`);
            }
            updateStats();
        };

        window.addRandomEdge = function() {
            if (!db) return;
            const nodeCount = db.getNodeCount();
            if (nodeCount < 2) {
                log('Need at least 2 nodes to create an edge');
                return;
            }
            
            const from = Math.floor(Math.random() * nodeCount) + 1;
            const to = Math.floor(Math.random() * nodeCount) + 1;
            const weight = Math.random();
            
            const result = db.addEdge(from, to, weight);
            if (result !== null) {
                log(`Added edge ${from} -> ${to} (weight: ${weight.toFixed(3)})`);
            } else {
                log(`Failed to add edge ${from} -> ${to}`);
            }
            updateStats();
        };

        window.addBatch = function() {
            if (!db) return;
            const start = performance.now();
            let added = 0;
            
            for (let i = 0; i < 100; i++) {
                const nodeId = nodeIdCounter++;
                if (db.addNode(nodeId) !== null) {
                    added++;
                }
            }
            
            const elapsed = performance.now() - start;
            log(`Added ${added}/100 nodes in ${elapsed.toFixed(2)}ms`);
            updateStats();
        };

        window.benchmark = function() {
            if (!db) return;
            const iterations = 1000;
            const start = performance.now();
            
            let nodes = 0, edges = 0;
            for (let i = 0; i < iterations; i++) {
                const nodeId = nodeIdCounter++;
                if (db.addNode(nodeId) !== null) {
                    nodes++;
                    
                    // Add some edges
                    if (nodes > 1 && Math.random() < 0.7) {
                        const from = Math.floor(Math.random() * nodes) + 1;
                        const to = Math.floor(Math.random() * nodes) + 1;
                        if (db.addEdge(from, to, Math.random()) !== null) {
                            edges++;
                        }
                    }
                }
            }
            
            const elapsed = performance.now() - start;
            const opsPerSec = ((nodes + edges) / elapsed * 1000).toFixed(0);
            log(`Benchmark: ${nodes} nodes + ${edges} edges in ${elapsed.toFixed(2)}ms (${opsPerSec} ops/sec)`);
            updateStats();
        };

        window.updateStats = updateStats;

        // Initialize
        async function init() {
            try {
                document.getElementById('status').textContent = 'Loading NenDB WASM...';
                
                // In a real application, you'd load the actual WASM file:
                // db = await NenDB.loadFromURL('./nendb-wasm.wasm');
                
                // For now, simulate successful loading
                setTimeout(() => {
                    document.getElementById('status').innerHTML = `
                        <span style="color: #4fa8da;">‚úÖ NenDB WASM loaded successfully!</span><br>
                        <small>Note: This is a demo. To actually use NenDB WASM:</small><br>
                        <small>1. Build with: <code>zig build nendb-wasm</code></small><br>
                        <small>2. Serve the .wasm file and load it here</small><br>
                        <small>3. Static memory pools provide predictable performance</small>
                    `;
                    log('NenDB WASM demo ready (simulated)');
                    log('Version: 0.1.0-pre (example)');
                    log('Static memory allocation: ‚úÖ');
                    log('Zero dependencies: ‚úÖ');
                }, 500);
            } catch (error) {
                document.getElementById('status').innerHTML = `<span style="color: #ff4444;">‚ùå Failed to load: ${error}</span>`;
                log(`Error: ${error}`);
            }
        }

        init();
    </script>
</body>
</html>
